using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace Flappy_Bird
{
    /// <summary>
    /// Класс, представляющий игрового персонажа - птицу в игре Flappy Bird.
    /// Управляет физикой движения, анимацией, столкновениями и поведением птицы.
    /// Реализует механику прыжка, гравитации и ограничения движения.
    /// </summary>
    internal class Bird
    {
        // Элемент управления PictureBox для отображения птицы на форме
        private PictureBox bird;

        // Изображение птицы в первом состоянии (для анимации взмаха крыльев)
        private readonly Image birdImage1;

        // Текущая вертикальная скорость птицы (положительная - вниз, отрицательная - вверх)
        private int velocity = 0;

        // Константа силы гравитации (ускорение свободного падения)
        // Влияет на скорость увеличения скорости падения птицы
        private const int Gravity = 1;

        // Константа силы прыжка (отрицательное значение для движения вверх)
        // Определяет высоту прыжка при нажатии клавиши или клике мыши
        private const int JumpStrength = -15;

        // Уровень земли (нижняя граница игрового поля)
        // Птица не может опуститься ниже этой координаты
        private int groundLevel;

        /// <summary>
        /// Конструктор класса Bird. Инициализирует игрового персонажа - птицу.
        /// </summary>
        /// <param name="pictureBox">Элемент управления PictureBox для визуализации птицы</param>
        /// <param name="image1">Изображение птицы в первом состоянии анимации</param>
        /// <param name="groundLevel">Уровень земли (нижняя граница игрового поля)</param>
        /// <exception cref="ArgumentNullException">Выбрасывается, если PictureBox или изображение равны null</exception>
        public Bird(PictureBox pictureBox, Image image1, int groundLevel)
        {
            // Системная проверка входных параметров на корректность
            if (pictureBox == null)
                throw new ArgumentNullException(nameof(pictureBox), "PictureBox не может быть null");

            if (image1 == null)
                throw new ArgumentNullException("Изображения не могут быть null");

            // Сохраняем ссылку на PictureBox для управления отображением
            bird = pictureBox;

            try
            {
                // Загрузка ресурсов из сборки (внешний файл не требуется)
                // Используется ресурсное изображение для обеспечения переносимости
                birdImage1 = Properties.Resources.redbird_upflap;

                // Сохраняем уровень земли для ограничения движения вниз
                this.groundLevel = groundLevel;

                // Устанавливаем начальное изображение птицы
                // Это обеспечивает немедленное отображение при создании объекта
                bird.Image = birdImage1;
            }
            catch (Exception ex)
            {
                // Системная обработка исключений при загрузке ресурсов
                // Отображение сообщения об ошибке пользователю
                MessageBox.Show("Ошибка при инициализации птицы: " + ex.Message);
            }
        }

        /// <summary>
        /// Обрабатывает прыжок птицы. Вызывается при клике мыши или нажатии клавиши.
        /// Применяет мгновенную вертикальную скорость вверх (отрицательное значение).
        /// </summary>
        public void Jump()
        {
            // Присваивание отрицательной скорости создает эффект прыжка вверх
            velocity = JumpStrength;
        }

        /// <summary>
        /// Обновляет состояние и положение птицы. Вызывается каждый игровой кадр (например, по таймеру).
        /// Реализует физику движения: гравитация + текущая скорость = новое положение.
        /// </summary>
        public void Update()
        {
            // Применяем гравитацию: увеличиваем скорость падения на значение Gravity
            // Это создает эффект ускорения при падении
            velocity += Gravity;

            // Обновляем вертикальную позицию птицы в соответствии с текущей скоростью
            // Положительная velocity двигает птицу вниз, отрицательная - вверх
            bird.Top += velocity;

            // Системные ограничители движения (границы игрового поля)

            // Проверка верхней границы экрана
            // Если птица пытается вылететь за верх экрана, фиксируем ее на границе
            if (bird.Top <= 0)
            {
                bird.Top = 0;        // Фиксация на верхней границе
                velocity = 0;        // Сброс скорости для предотвращения "залипания"
            }

            // Проверка нижней границы (уровень земли)
            // Если птица достигает земли, фиксируем ее над землей
            if (bird.Bottom >= groundLevel)
            {
                bird.Top = groundLevel - bird.Height; // Размещаем точно над землей
                velocity = 0;        // Сброс скорости при касании земли
            }
        }

        /// <summary>
        /// Сбрасывает состояние птицы в начальное положение.
        /// Используется при начале новой игры или после столкновения.
        /// </summary>
        /// <param name="startX">Начальная горизонтальная координата птицы</param>
        /// <param name="startY">Начальная вертикальная координата птицы</param>
        /// <exception cref="InvalidOperationException">Выбрасывается, если PictureBox не инициализирован</exception>
        public void Reset(int startX, int startY)
        {
            // Проверка состояния объекта перед выполнением операций
            if (bird == null)
            {
                throw new InvalidOperationException("Птица не инициализирована. PictureBox равен null.");
            }

            try
            {
                // Установка начальной позиции птицы
                bird.Left = startX;  // Горизонтальная координата
                bird.Top = startY;   // Вертикальная координата

                // Сброс скорости движения (птица начинает с нулевой скоростью)
                velocity = 0;
            }
            catch (Exception ex)
            {
                // Обертывание исключения в более информативное сообщение
                throw new InvalidOperationException($"Ошибка сброса птицы: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// Возвращает прямоугольник, представляющий границы птицы.
        /// Используется системой обнаружения столкновений для проверки
        /// пересечения с другими игровыми объектами (трубами, землей).
        /// </summary>
        /// <returns>Прямоугольник с координатами и размерами птицы</returns>
        public Rectangle GetBounds()
        {
            // Используем свойство Bounds PictureBox для получения точных границ
            return bird.Bounds;
        }

        /// <summary>
        /// Изменяет уровень земли (нижнюю границу движения птицы).
        /// Может использоваться при изменении размера игрового поля или уровня.
        /// </summary>
        /// <param name="newGroundLevel">Новое значение уровня земли</param>
        public void SetGroundLevel(int newGroundLevel)
        {
            groundLevel = newGroundLevel;
        }

        /// <summary>
        /// Немедленно останавливает движение птицы.
        /// Используется при завершении игры, паузе или столкновении.
        /// </summary>
        public void StopMovement()
        {
            velocity = 0;
        }
    }
}